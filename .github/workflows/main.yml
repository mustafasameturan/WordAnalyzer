name: Deploy to Ubuntu Server

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  PROJECT_PATH: /home/mst-projects/be/WordAnalyzer

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“± Telegram - Deployment Started
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          ğŸš€ **${{ github.event.repository.name }} Deployment STARTED**
          
          ğŸ“ **Message:** ${{ github.event.head_commit.message }}
          ğŸŒ¿ **Branch:** ${{ github.ref_name }}
          ğŸ‘¤ **Author:** ${{ github.actor }}
          
          â±ï¸ **Estimated Duration:** ~1-5 minutes
          ğŸ”„ **Status:** In Progress...
          
          _Please wait while the application is being deployed..._
          
    - name: ğŸ“ Get Commit Info
      id: commit-info
      run: |
        echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        
    - name: ğŸ• Get Time Info
      id: time-info
      run: |
        echo "start_time=$(date '+%H:%M:%S')" >> $GITHUB_OUTPUT
          
    - name: â±ï¸ Start Deployment Timer
      id: deployment-timer
      run: |
        echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
    - name: Pre-deployment System Check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.UBUNTU_HOST }}
        username: ${{ secrets.UBUNTU_USERNAME }}
        key: ${{ secrets.UBUNTU_SSH_KEY }}
        port: 1453
        timeout: 30s
        script: |
          echo "ğŸ” Pre-deployment system checks..."
          
          # Disk space kontrolÃ¼
          DISK_USAGE=$(df /home | tail -1 | awk '{print $5}' | sed 's/%//')
          if [ $DISK_USAGE -gt 85 ]; then
            echo "âŒ ERROR: Disk usage is ${DISK_USAGE}%. Deployment aborted!"
            exit 1
          fi
          echo "âœ… Disk usage: ${DISK_USAGE}% (OK)"
          
          # Memory kontrolÃ¼
          FREE_MEM=$(free | awk 'FNR==2{printf "%.1f", $7/1024/1024}')
          echo "âœ… Available memory: ${FREE_MEM}GB"
          
          # Docker servis kontrolÃ¼
          if ! systemctl is-active docker >/dev/null 2>&1; then
            echo "âŒ Docker service is not running!"
            exit 1
          fi
          echo "âœ… Docker service is running"
          
          echo "ğŸ¯ System checks completed successfully"

    - name: Deploy Application
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.UBUNTU_HOST }}
        username: ${{ secrets.UBUNTU_USERNAME }}
        key: ${{ secrets.UBUNTU_SSH_KEY }}
        port: 1453
        command_timeout: 15m  # Timeout eklendi
        script: |
          cd ${{ env.PROJECT_PATH }}
          
          echo "ğŸš€ Starting deployment process..."
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ• Time: $(date)"
          
          # Git gÃ¼ncellemesi
          echo "ğŸ“¥ Pulling latest changes..."
          git stash --include-untracked >/dev/null 2>&1 || true
          git pull origin master
          
          # Portainer ayarlarÄ±nÄ± korumak iÃ§in container'larÄ± graceful shutdown
          echo "ğŸ›‘ Gracefully stopping containers..."
          docker compose down --timeout 45
          
          # Yeni container'larÄ± baÅŸlat
          echo "ğŸ”„ Starting updated containers..."
          docker compose up -d --build --remove-orphans
          
          # Container'larÄ±n baÅŸlamasÄ±nÄ± bekle
          echo "â³ Waiting for containers to be ready..."
          sleep 30
          
          # Container durumlarÄ±nÄ± kontrol et
          echo "ğŸ“Š Container status:"
          docker compose ps
          
          echo "âœ… Deployment process completed!"

    - name: Cleanup Resources
      uses: appleboy/ssh-action@v1.0.0
      if: always()  # Her durumda Ã§alÄ±ÅŸtÄ±r
      with:
        host: ${{ secrets.UBUNTU_HOST }}
        username: ${{ secrets.UBUNTU_USERNAME }}
        key: ${{ secrets.UBUNTU_SSH_KEY }}
        port: 1453
        script: |
          cd ${{ env.PROJECT_PATH }}
          
          echo "ğŸ§¹ Cleaning up resources..."
          
          # KullanÄ±lmayan image'larÄ± temizle
          docker image prune -f
          
          # KullanÄ±lmayan volume'larÄ± temizle (dikkatli)
          docker volume prune -f
          
          # Eski backup'larÄ± temizle (30 gÃ¼nden eski)
          find backups/ -type f -mtime +30 -delete 2>/dev/null || true
          find backups/ -type d -empty -delete 2>/dev/null || true
          
          # Build cache'i temizle (haftalÄ±k)
          if [ $(date +%u) -eq 1 ]; then  # Pazartesi
            echo "ğŸ“… Weekly deep clean..."
            docker builder prune -af --filter until=168h  # 7 gÃ¼n
          fi
          
          echo "âœ… Cleanup completed"

    - name: â±ï¸ Calculate Deployment Duration
      id: calc-duration
      if: always()
      run: |
        start_time=${{ steps.deployment-timer.outputs.start_time }}
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        
        # Convert to minutes and seconds
        minutes=$((duration / 60))
        seconds=$((duration % 60))
        
        if [ $minutes -gt 0 ]; then
          duration_text="${minutes}m ${seconds}s"
        else
          duration_text="${seconds}s"
        fi
        
        echo "duration=${duration_text}" >> $GITHUB_OUTPUT
        echo "total_seconds=${duration}" >> $GITHUB_OUTPUT

    - name: Post-deployment Summary
      if: always()
      run: |
        echo "ğŸ“‹ Deployment Summary"
        echo "===================="
        echo "ğŸ·ï¸  Repository: ${{ github.repository }}"
        echo "ğŸ“¦ Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "ğŸ• Time: $(date)"
        echo "ğŸ“ˆ Status: ${{ job.status }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ”— Application URL: ${{ env.HEALTH_CHECK_URL }}"
        else
          echo "âŒ Deployment failed - Check logs above"
        fi

    # Telegram notification
    - name: ğŸ“± Telegram - Deployment Completed
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          ${{ job.status == 'success' && format('âœ… **{0} Deployment SUCCESS**', github.event.repository.name) || format('âŒ **{0} Deployment FAILED**', github.event.repository.name) }}
          
          ğŸ“¦ **Commit:** `${{ steps.commit-info.outputs.short_sha }}`
          ğŸ“ **Message:** ${{ github.event.head_commit.message }}
          ğŸŒ¿ **Branch:** ${{ github.ref_name }}
          ğŸ‘¤ **Author:** ${{ github.actor }}
          â±ï¸ **Duration:** ${{ steps.calc-duration.outputs.duration || 'N/A' }}
          
          ${{ job.status == 'success' && 'ğŸ‰ **Application is live and healthy!**' || 'âš ï¸ **Check logs for error details**' }}
          
          ${{ job.status == 'success' && '_Deployment completed successfully! ğŸš€_' || '_Deployment failed. Manual check required. ğŸ”§_' }}
